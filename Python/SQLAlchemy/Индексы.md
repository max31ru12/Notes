

## Задание индексов при использовании `mapped_column`

### Простой одиночный индекс

```python
email: Mapped[str] = mapped_column(String(256), index=True, nullable=False)
```

- Создается обычный **Btree-индекс** (по умолчанию в Postgres).
- Хорошо для простых фильтров `where email = `
- Обычно **не нужно** ставить одновременно `unique=True` и `index=True` — лишнее.


### Составной индекс / частичный / выражение / GIN и т.п.

При использовании **mapped_column** задается в атрибуте __table_args__

```python
from sqlalchemy import Index, text
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column
from sqlalchemy import String, DateTime, Boolean

class Base(DeclarativeBase): ...

class User(Base):
    __tablename__ = "users"
    
    id: Mapped[int] = mapped_column(primary_key=True)
    last_name: Mapped[str] = mapped_column(String(128), nullable=False)
    first_name: Mapped[str] = mapped_column(String(128), nullable=False)
    deleted: Mapped[bool] = mapped_column(Boolean, server_default=text("false"), nullable=False)
    
    __table_args__ = (
        Index("ix_users_last_first", "last_name", "first_name"),
        Index("ix_users_not_deleted_last", "last_name", postgresql_where=text("deleted = false")),
    )
```


#### GIN-index

Чаще всего - это JSON, массивы, fulltext

```python
from sqlalchemy.dialects.postgresql import JSONB
from sqlalchemy import Index

data: Mapped[dict] = mapped_column(JSONB)

__table_args__ = (
    Index("ix_events_data_gin", "data", postgresql_using="gin"),
)

```


#### Partial Index

Когда **soft-delete** (активные пользователи, не удаленные записи, статус = pending)

- Вешается на те поля, по которым происходит поиск / сортировка
- Строки с `deleted = true` для поиска вообще не видны, их при поиске не проходят
- Не фильтрует таблицу автоматически

```python
postgresql_where=text("deleted = false")
```